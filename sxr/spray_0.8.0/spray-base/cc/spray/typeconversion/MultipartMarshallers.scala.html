<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>cc/spray/typeconversion/MultipartMarshallers.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright (C) 2011 Mathias Doenitz
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> cc.spray
<span class="keyword">package</span> typeconversion

<span class="keyword">import</span> utils._
<span class="keyword">import</span> http._
<span class="keyword">import</span> <a href="../http/MediaType.scala.html#9667" title="object cc.spray.http.MediaTypes">MediaTypes</a>._
<span class="keyword">import</span> <a href="../http/HttpHeader.scala.html#9606" title="object cc.spray.http.HttpHeaders">HttpHeaders</a>._
<span class="keyword">import</span> util.Random
<span class="keyword">import</span> org.parboiled.common.Base64
<span class="keyword">import</span> java.io.ByteArrayOutputStream

<span class="keyword">trait</span> <a title="trait MultipartMarshallers extends java.lang.Object with ScalaObject" id="9932">MultipartMarshallers</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="scala.util.Random" id="87700">multipartBoundaryRandom</a> = <span title="()scala.util.Random" class="keyword">new</span> <span title="scala.util.Random">Random</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Creates a new random 144-bit number and base64 encodes it (RFC2045, yielding 24 characters).
   */</span>
  <span class="keyword">def</span> <a title="=&gt; java.lang.String" id="87701">randomBoundary</a> = <span class="delimiter">{</span>
    <span title="object org.parboiled.common.Base64">Base64</span>.<span title="()org.parboiled.common.Base64">rfc2045</span>.<span title="(x$1: Array[Byte], x$2: Boolean)java.lang.String">encodeToString</span><span class="delimiter">(</span><a href="../utils/package.scala.html#10092" title="(a: Array[Byte])(f: Array[Byte] =&gt; Unit)Array[Byte]">make</a><span class="delimiter">(</span><span title="Array[Byte]" class="keyword">new</span> <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(18)" class="int">18</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#87699" title="=&gt; scala.util.Random">multipartBoundaryRandom</a>.<span title="(bytes: Array[Byte])Unit">nextBytes</span><span class="delimiter">(</span><a href="#87784" title="Array[Byte]">_</a><span class="delimiter">)</span> <span class="delimiter">}</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">implicit</span> <span class="keyword">val</span> <a title="cc.spray.typeconversion.MarshallerBase[cc.spray.http.MultipartContent]" id="87702">MultipartContentMarshaller</a> = <a href="#87851" title="cc.spray.typeconversion.MarshallerBase[cc.spray.http.MultipartContent]" class="keyword">new</a> <a title="anonymous class $anon extends cc.spray.typeconversion.MarshallerBase[cc.spray.http.MultipartContent]" id="87851">MarshallerBase</a><span class="delimiter">[</span>MultipartContent<span class="delimiter">]</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="=&gt; List[cc.spray.http.ContentType]" id="87853">canMarshalTo</a> = <a href="../http/ContentType.scala.html#25287" title="(mediaType: cc.spray.http.MediaType)cc.spray.http.ContentType">ContentType</a><span class="delimiter">(</span><span title="cc.spray.http.MediaTypes.multipart/mixed" class="keyword">new</span> <a href="../http/MediaType.scala.html#22937" title="cc.spray.http.MediaTypes.multipart/mixed">`multipart/mixed`</a><span class="delimiter">(</span><span title="(x: java.lang.String)Some[java.lang.String]">Some</span><span class="delimiter">(</span><a href="#87701" title="=&gt; java.lang.String">randomBoundary</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#87855" title="(x: cc.spray.http.ContentType)List[cc.spray.http.ContentType]">::</a> <span title="object Nil">Nil</span>

    <span class="keyword">def</span> <a title="(value: cc.spray.http.MultipartContent, contentType: cc.spray.http.ContentType)cc.spray.http.HttpContent" id="87854">marshal</a><span class="delimiter">(</span><a title="cc.spray.http.MultipartContent" id="87868">value</a>: <a href="../http/MultipartContent.scala.html#9673" title="cc.spray.http.MultipartContent">MultipartContent</a>, <a title="cc.spray.http.ContentType" id="87869">contentType</a>: <a href="../http/ContentType.scala.html#9532" title="cc.spray.http.ContentType">ContentType</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="87872">out</a> = <span title="(x$1: Int)java.io.ByteArrayOutputStream" class="keyword">new</span> <span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span><span class="delimiter">(</span><span title="Int(1024)" class="int">1024</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="String" id="87873">boundary</a> = <a href="#87869" title="cc.spray.http.ContentType">contentType</a>.<a href="../http/ContentType.scala.html#25271" title="=&gt; cc.spray.http.MediaType">mediaType</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="cc.spray.http.MediaTypes.MultipartMediaType" class="delimiter">[</span><a href="../http/MediaType.scala.html#22880" title="cc.spray.http.MediaTypes.MultipartMediaType">MultipartMediaType</a><span class="delimiter">]</span>.<a href="../http/MediaType.scala.html#35332" title="=&gt; Option[String]">boundary</a>.<span title="=&gt; String">get</span>

      <span class="keyword">def</span> <a title="()Unit" id="87874">putCrLf</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#87876" title="(char: Char)Unit">put</a><span class="delimiter">(</span><span title="Char(\'\\r\')" class="char">'\r'</span><span class="delimiter">)</span>; <a href="#87876" title="(char: Char)Unit">put</a><span class="delimiter">(</span><span title="Char(\'\\n\')" class="char">'\n'</span><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span class="keyword">def</span> <a title="()Unit" id="87875">putDashDash</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#87876" title="(char: Char)Unit">put</a><span class="delimiter">(</span><span title="Char(\'-\')" class="char">'-'</span><span class="delimiter">)</span>; <a href="#87876" title="(char: Char)Unit">put</a><span class="delimiter">(</span><span title="Char(\'-\')" class="char">'-'</span><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span class="keyword">def</span> <a title="(char: Char)Unit" id="87876">put</a><span class="delimiter">(</span><a title="Char" id="87881">char</a>: <span title="Char">Char</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#87872" title="java.io.ByteArrayOutputStream">out</a>.<span title="(x$1: Int)Unit">write</span><span class="delimiter">(</span><a href="#87881" title="Char">char</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="=&gt; Int" class="delimiter">[</span><span title="Byte">Byte</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span class="keyword">def</span> <a title="(name: String, value: String)Unit" id="87877">putHeader</a><span class="delimiter">(</span><a title="String" id="87886">name</a>: <span title="String">String</span>, <a title="String" id="87887">value</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#87878" title="(string: String)Unit">putString</a><span class="delimiter">(</span><a href="#87886" title="String">name</a><span class="delimiter">)</span>; <a href="#87876" title="(char: Char)Unit">put</a><span class="delimiter">(</span><span title="Char(\':\')" class="char">':'</span><span class="delimiter">)</span>; <a href="#87876" title="(char: Char)Unit">put</a><span class="delimiter">(</span><span title="Char(\' \')" class="char">' '</span><span class="delimiter">)</span>; <a href="#87878" title="(string: String)Unit">putString</a><span class="delimiter">(</span><a href="#87887" title="String">value</a><span class="delimiter">)</span>; <a href="#87874" title="()Unit">putCrLf</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span class="keyword">def</span> <a title="(string: String)Unit" id="87878">putString</a><span class="delimiter">(</span><a title="String" id="87888">string</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Array[Char]" id="87889">chars</a> = <span title="Array[Char]" class="keyword">new</span> <span title="Array[Char]">Array</span><span class="delimiter">[</span>Char<span class="delimiter">]</span><span class="delimiter">(</span><a href="#87888" title="String">string</a>.<span title="()Int">length</span><span class="delimiter">)</span>
        <a href="#87888" title="String">string</a>.<span title="(x$1: Int, x$2: Int, x$3: Array[Char], x$4: Int)Unit">getChars</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <a href="#87888" title="String">string</a>.<span title="()Int">length</span>, <a href="#87889" title="Array[Char]">chars</a>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span class="keyword">var</span> <a title="Int" id="87890">i</a> = <span title="Int(0)" class="int">0</span>
        <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#87890" title="Int">i</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#87889" title="Array[Char]">chars</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span> <a href="#87894" title="()Unit" class="delimiter">{</a> <a href="#87876" title="(char: Char)Unit">put</a><span class="delimiter">(</span><a href="#87889" title="(i: Int)Char">chars</a><span class="delimiter">(</span><a href="#87890" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>; <a href="#87890" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span> <span class="delimiter">}</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#87868" title="cc.spray.http.MultipartContent">value</a>.<a href="../http/MultipartContent.scala.html#35540" title="=&gt; Seq[cc.spray.http.BodyPart]">parts</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#87868" title="cc.spray.http.MultipartContent">value</a>.<a href="../http/MultipartContent.scala.html#35540" title="=&gt; Seq[cc.spray.http.BodyPart]">parts</a>.<span title="(f: cc.spray.http.BodyPart =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="cc.spray.http.BodyPart" id="87919">part</a> =&gt;
          <a href="#87875" title="()Unit">putDashDash</a><span class="delimiter">(</span><span class="delimiter">)</span>; <a href="#87878" title="(string: String)Unit">putString</a><span class="delimiter">(</span><a href="#87873" title="String">boundary</a><span class="delimiter">)</span>; <a href="#87874" title="()Unit">putCrLf</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#87919" title="cc.spray.http.BodyPart">part</a>.<a href="../http/MultipartContent.scala.html#37329" title="=&gt; List[cc.spray.http.HttpHeader]">headers</a>.<span title="(f: cc.spray.http.HttpHeader =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="cc.spray.http.HttpHeader" id="87939">header</a> =&gt;
            <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#87939" title="cc.spray.http.HttpHeader">header</a>.<a href="../http/HttpHeader.scala.html#23105" title="=&gt; java.lang.String">name</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="java.lang.String(&quot;Content-Type&quot;)" class="string">&quot;Content-Type&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span>
            <a href="#87877" title="(name: String, value: String)Unit">putHeader</a><span class="delimiter">(</span><a href="#87939" title="cc.spray.http.HttpHeader">header</a>.<a href="../http/HttpHeader.scala.html#23105" title="=&gt; java.lang.String">name</a>, <a href="#87939" title="cc.spray.http.HttpHeader">header</a>.<a href="../http/HttpHeader.scala.html#23107" title="=&gt; String">value</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <a href="#87919" title="cc.spray.http.BodyPart">part</a>.<a href="../http/MultipartContent.scala.html#37331" title="=&gt; Option[cc.spray.http.HttpContent]">content</a>.<span title="(f: cc.spray.http.HttpContent =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="cc.spray.http.HttpContent" id="87951">content</a> =&gt;
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#87951" title="cc.spray.http.HttpContent">content</a>.<a href="../http/HttpContent.scala.html#25396" title="=&gt; Array[Byte]">buffer</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#87877" title="(name: String, value: String)Unit">putHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Content-Type&quot;)" class="string">&quot;Content-Type&quot;</span>, <a href="#87951" title="cc.spray.http.HttpContent">content</a>.<a href="../http/HttpContent.scala.html#25394" title="=&gt; cc.spray.http.ContentType">contentType</a>.<a href="../http/ContentType.scala.html#25276" title="=&gt; String">value</a><span class="delimiter">)</span>
              <a href="#87874" title="()Unit">putCrLf</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#87872" title="java.io.ByteArrayOutputStream">out</a>.<span title="(x$1: Array[Byte])Unit">write</span><span class="delimiter">(</span><a href="#87951" title="cc.spray.http.HttpContent">content</a>.<a href="../http/HttpContent.scala.html#25396" title="=&gt; Array[Byte]">buffer</a><span class="delimiter">)</span>
              <a href="#87874" title="()Unit">putCrLf</a><span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <a href="#87875" title="()Unit">putDashDash</a><span class="delimiter">(</span><span class="delimiter">)</span>; <a href="#87878" title="(string: String)Unit">putString</a><span class="delimiter">(</span><a href="#87873" title="String">boundary</a><span class="delimiter">)</span>; <a href="#87875" title="()Unit">putDashDash</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="../http/HttpContent.scala.html#25371" title="(contentType: cc.spray.http.ContentType, buffer: Array[Byte])cc.spray.http.HttpContent">HttpContent</a><span class="delimiter">(</span><a href="#87869" title="cc.spray.http.ContentType">contentType</a>, <a href="#87872" title="java.io.ByteArrayOutputStream">out</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">implicit</span> <span class="keyword">val</span> <a title="cc.spray.typeconversion.MarshallerBase[cc.spray.http.MultipartFormData]" id="87704">MultipartFormDataMarshaller</a> = <a href="#87757" title="cc.spray.typeconversion.MarshallerBase[cc.spray.http.MultipartFormData]" class="keyword">new</a> <a title="anonymous class $anon extends cc.spray.typeconversion.MarshallerBase[cc.spray.http.MultipartFormData]" id="87757">MarshallerBase</a><span class="delimiter">[</span>MultipartFormData<span class="delimiter">]</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="=&gt; List[cc.spray.http.ContentType]" id="87759">canMarshalTo</a> = <a href="../http/ContentType.scala.html#25287" title="(mediaType: cc.spray.http.MediaType)cc.spray.http.ContentType">ContentType</a><span class="delimiter">(</span><span title="cc.spray.http.MediaTypes.multipart/form-data" class="keyword">new</span> <a href="../http/MediaType.scala.html#22946" title="cc.spray.http.MediaTypes.multipart/form-data">`multipart/form-data`</a><span class="delimiter">(</span><span title="(x: java.lang.String)Some[java.lang.String]">Some</span><span class="delimiter">(</span><a href="#87701" title="=&gt; java.lang.String">randomBoundary</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#87761" title="(x: cc.spray.http.ContentType)List[cc.spray.http.ContentType]">::</a> <span title="object Nil">Nil</span>

    <span class="keyword">def</span> <a title="(value: cc.spray.http.MultipartFormData, contentType: cc.spray.http.ContentType)cc.spray.http.HttpContent" id="87760">marshal</a><span class="delimiter">(</span><a title="cc.spray.http.MultipartFormData" id="87847">value</a>: <a href="../http/MultipartContent.scala.html#9676" title="cc.spray.http.MultipartFormData">MultipartFormData</a>, <a title="cc.spray.http.ContentType" id="87848">contentType</a>: <a href="../http/ContentType.scala.html#9532" title="cc.spray.http.ContentType">ContentType</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#87702" title="=&gt; cc.spray.typeconversion.MarshallerBase[cc.spray.http.MultipartContent]">MultipartContentMarshaller</a>.<a href="MarshallerBase.scala.html#87723" title="(value: cc.spray.http.MultipartContent, contentType: cc.spray.http.ContentType)cc.spray.http.HttpContent">marshal</a><span class="delimiter">(</span>
        value = <a href="../http/MultipartContent.scala.html#35629" title="(parts: Seq[cc.spray.http.BodyPart])cc.spray.http.MultipartContent">MultipartContent</a> <span class="delimiter">{</span>
          <a href="#87847" title="cc.spray.http.MultipartFormData">value</a>.<a href="../http/MultipartContent.scala.html#37593" title="=&gt; Map[String,cc.spray.http.BodyPart]">parts</a>.<span title="(f: (String, cc.spray.http.BodyPart) =&gt; cc.spray.http.BodyPart)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Map[String,cc.spray.http.BodyPart],cc.spray.http.BodyPart,Seq[cc.spray.http.BodyPart]])Seq[cc.spray.http.BodyPart]">map</span> <a href="#88006" title="cc.spray.http.BodyPart" class="delimiter">{</a>
            <span class="keyword">case</span> <span title="cc.spray.http.BodyPart" class="delimiter">(</span><a title="String" id="88009">name</a>, <a title="cc.spray.http.BodyPart" id="88010">part</a><span class="delimiter">)</span> =&gt; <a href="#88010" title="cc.spray.http.BodyPart">part</a>.<a href="../http/MultipartContent.scala.html#37334" title="(headers: List[cc.spray.http.HttpHeader], content: Option[cc.spray.http.HttpContent])cc.spray.http.BodyPart">copy</a><span class="delimiter">(</span>
              headers = <a href="../http/HttpHeader.scala.html#37991" title="(dispositionType: String, parameters: Map[String,String])cc.spray.http.HttpHeaders.Content-Disposition">`Content-Disposition`</a><span class="delimiter">(</span><span title="java.lang.String(&quot;form-data&quot;)" class="string">&quot;form-data&quot;</span>, <span title="(elems: (java.lang.String, String)*)scala.collection.immutable.Map[java.lang.String,String]">Map</span><span class="delimiter">(</span><span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;name&quot;</span> <span title="(y: String)(java.lang.String, String)">-&gt;</span> <a href="#88009" title="String">name</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#88011" title="(x: cc.spray.http.HttpHeader)List[cc.spray.http.HttpHeader]">::</a> <a href="#88010" title="cc.spray.http.BodyPart">part</a>.<a href="../http/MultipartContent.scala.html#37329" title="=&gt; List[cc.spray.http.HttpHeader]">headers</a>
            <span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="delimiter">(</span>collection.<span title="(implicit b: scala.collection.generic.CanBuildFrom[Nothing,cc.spray.http.BodyPart,Seq[cc.spray.http.BodyPart]])scala.collection.generic.CanBuildFrom[scala.collection.immutable.Map[String,cc.spray.http.BodyPart],cc.spray.http.BodyPart,Seq[cc.spray.http.BodyPart]]">breakOut</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>,
        contentType = <a href="#87848" title="cc.spray.http.ContentType">contentType</a>
      <span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object cc.spray.typeconversion.MultipartMarshallers" id="9933">MultipartMarshallers</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9932" title="cc.spray.typeconversion.MultipartMarshallers">MultipartMarshaller</a>s
        </pre>
    </body>
</html>