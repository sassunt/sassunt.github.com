<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>cc/spray/connectors/ConnectorServlet.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright (C) 2011 Mathias Doenitz
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> cc.spray
<span class="keyword">package</span> connectors

<span class="keyword">import</span> utils.Logging
<span class="keyword">import</span> collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> javax.servlet.http.<span class="delimiter">{</span>HttpServletResponse, HttpServletRequest, HttpServlet<span class="delimiter">}</span>
<span class="keyword">import</span> utils.<span title="object cc.spray.utils.ActorHelpers">ActorHelpers</span>._
<span class="keyword">import</span> http._
<span class="keyword">import</span> <span title="object cc.spray.http.HttpHeaders">HttpHeaders</span>._
<span class="keyword">import</span> <span title="object cc.spray.http.StatusCodes">StatusCodes</span>._
<span class="keyword">import</span> <span title="object cc.spray.http.MediaTypes">MediaTypes</span>._
<span class="keyword">import</span> java.util.concurrent.<span class="delimiter">{</span>TimeUnit, CountDownLatch<span class="delimiter">}</span>
<span class="keyword">import</span> java.io.<span class="delimiter">{</span>IOException, InputStream<span class="delimiter">}</span>

<span class="keyword">private</span><span class="delimiter">[</span>connectors<span class="delimiter">]</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class ConnectorServlet extends javax.servlet.http.HttpServlet with cc.spray.utils.Logging with ScalaObject" id="9690">ConnectorServlet</a><a href="#9690" title="ScalaObject" class="delimiter">(</a><a title="String" id="40625">containerName</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="javax.servlet.http.HttpServlet">HttpServlet</span> <span class="keyword">with</span> <span title="cc.spray.utils.Logging">Logging</span> <span class="delimiter">{</span>
  <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="akka.actor.ActorRef" id="40553">rootService</a> = <span title="(id: String)akka.actor.ActorRef">actor</span><span class="delimiter">(</span><a href="../SprayServerSettings.scala.html#9650" title="object cc.spray.SprayServerSettings">SprayServerSettings</a>.<a href="../SprayServerSettings.scala.html#35005" title="=&gt; String">RootActorId</a><span class="delimiter">)</span>
  <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="akka.actor.ActorRef" id="40555">timeoutActor</a> = <span title="(id: String)akka.actor.ActorRef">actor</span><span class="delimiter">(</span><a href="../SprayServerSettings.scala.html#9650" title="object cc.spray.SprayServerSettings">SprayServerSettings</a>.<a href="../SprayServerSettings.scala.html#35007" title="=&gt; String">TimeoutActorId</a><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="Array[Byte]" id="40556">EmptyByteArray</a> = <span title="Array[Byte]" class="keyword">new</span> <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
  <span class="keyword">var</span> <a title="Int" id="40559">timeout</a>: <span title="Int">Int</span> = _

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="40561">init</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#9690" title="=&gt; cc.spray.utils.Log">log</a>.<span title="(msgFmt: String, a: =&gt; Any)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Initializing %s &lt;=&gt; Spray Connector&quot;)" class="string">&quot;Initializing %s &lt;=&gt; Spray Connector&quot;</span>, <a href="#40625" title="String">containerName</a><span class="delimiter">)</span>
    <a href="#40559" title="(x$1: Int)Unit">timeout</a> = <a href="../SprayServerSettings.scala.html#9650" title="object cc.spray.SprayServerSettings">SprayServerSettings</a>.<a href="../SprayServerSettings.scala.html#35009" title="=&gt; Int">RequestTimeout</a>
    <a href="#9690" title="=&gt; cc.spray.utils.Log">log</a>.<span title="(msgFmt: String, a: =&gt; Any)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Async timeout for all requests is %s ms&quot;)" class="string">&quot;Async timeout for all requests is %s ms&quot;</span>, <a href="#40559" title="=&gt; Int">timeout</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(req: javax.servlet.http.HttpServletRequest, resp: javax.servlet.http.HttpServletResponse, responder: cc.spray.RoutingResult =&gt; Unit)Option[cc.spray.RequestContext]" id="40562">requestContext</a><span class="delimiter">(</span><a title="javax.servlet.http.HttpServletRequest" id="41546">req</a>: <span title="javax.servlet.http.HttpServletRequest">HttpServletRequest</span>, <a title="javax.servlet.http.HttpServletResponse" id="41547">resp</a>: <span title="javax.servlet.http.HttpServletResponse">HttpServletResponse</span>,
                     <a title="cc.spray.RoutingResult =&gt; Unit" id="41548">responder</a>: RoutingResult =&gt; Unit<span class="delimiter">)</span>: <span title="Option[cc.spray.RequestContext]">Option</span><span class="delimiter">[</span>RequestContext<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      <span title="(x: cc.spray.RequestContext)Some[cc.spray.RequestContext]">Some</span> <span class="delimiter">{</span>
        <a href="../RequestContext.scala.html#33294" title="(request: cc.spray.http.HttpRequest, remoteHost: cc.spray.http.HttpIp, responder: cc.spray.RoutingResult =&gt; Unit, unmatchedPath: String)cc.spray.RequestContext">RequestContext</a><span class="delimiter">(</span>
          request = <a href="#40563" title="(req: javax.servlet.http.HttpServletRequest)cc.spray.http.HttpRequest">httpRequest</a><span class="delimiter">(</span><a href="#41546" title="javax.servlet.http.HttpServletRequest">req</a><span class="delimiter">)</span>,
          remoteHost = <a href="#41546" title="javax.servlet.http.HttpServletRequest">req</a>.<span title="implicit cc.spray.http.HttpIp.fromString : (s: String)cc.spray.http.HttpIp">getRemoteAddr</span>,
          responder = <a href="#41548" title="cc.spray.RoutingResult =&gt; Unit">responder</a>
        <span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="None.type">HttpException</span><span class="delimiter">(</span><a title="cc.spray.http.HttpFailure" id="42067">failure</a>, <a title="String" id="42068">reason</a><span class="delimiter">)</span> =&gt; <a href="#40566" title="(req: javax.servlet.http.HttpServletRequest, servletResponse: javax.servlet.http.HttpServletResponse, response: cc.spray.http.HttpResponse)Unit">respond</a><span class="delimiter">(</span><a href="#41546" title="javax.servlet.http.HttpServletRequest">req</a>, <a href="#41547" title="javax.servlet.http.HttpServletResponse">resp</a>, <span title="(status: cc.spray.http.StatusCode, content: String)cc.spray.http.HttpResponse">HttpResponse</span><span class="delimiter">(</span><a href="#42067" title="cc.spray.http.HttpFailure">failure</a>.<span title="implicit cc.spray.http.StatusCode.int2StatusCode : (code: Int)cc.spray.http.StatusCode">value</span>, <a href="#42068" title="String">reason</a><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="object None">None</span>
      <span class="keyword">case</span> <a title="None.type" id="42081">e</a>: <span title="Exception">Exception</span> =&gt; <a href="#40566" title="(req: javax.servlet.http.HttpServletRequest, servletResponse: javax.servlet.http.HttpServletResponse, response: cc.spray.http.HttpResponse)Unit">respond</a><span class="delimiter">(</span><a href="#41546" title="javax.servlet.http.HttpServletRequest">req</a>, <a href="#41547" title="javax.servlet.http.HttpServletResponse">resp</a>, <span title="(status: cc.spray.http.StatusCode, content: String)cc.spray.http.HttpResponse">HttpResponse</span><span class="delimiter">(</span><span title="implicit cc.spray.http.StatusCode.int2StatusCode : (code: Int)cc.spray.http.StatusCode" class="int">500</span>, <span title="java.lang.String(&quot;Internal Server Error:\012&quot;)" class="string">&quot;Internal Server Error:\n&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#42081" title="Exception">e</a>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="object None">None</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(req: javax.servlet.http.HttpServletRequest)cc.spray.http.HttpRequest" id="40563">httpRequest</a><span class="delimiter">(</span><a title="javax.servlet.http.HttpServletRequest" id="41692">req</a>: <span title="javax.servlet.http.HttpServletRequest">HttpServletRequest</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#41696" title="(Option[cc.spray.http.HttpHeaders.Content-Type], Option[cc.spray.http.HttpHeaders.Content-Length], List[cc.spray.http.HttpHeader])" class="delimiter">(</a><a href="#41695" title="Option[cc.spray.http.HttpHeaders.Content-Type]" id="41696">contentTypeHeader</a>, <a href="#41695" title="Option[cc.spray.http.HttpHeaders.Content-Length]" id="41697">contentLengthHeader</a>, <a href="#41695" title="List[cc.spray.http.HttpHeader]" id="41698">regularHeaders</a><span class="delimiter">)</span> = <span title="object cc.spray.http.HttpHeaders">HttpHeaders</span>.<span title="(rawHeaders: List[Product2[String,String]])(Option[cc.spray.http.HttpHeaders.Content-Type], Option[cc.spray.http.HttpHeaders.Content-Length], List[cc.spray.http.HttpHeader])">parseFromRaw</span> <span title="(Option[cc.spray.http.HttpHeaders.Content-Type], Option[cc.spray.http.HttpHeaders.Content-Length], List[cc.spray.http.HttpHeader]) @unchecked" class="delimiter">{</span>
      <a href="#41692" title="javax.servlet.http.HttpServletRequest">req</a>.<span title="(i: java.util.Enumeration[java.lang.String])Iterator[java.lang.String]">getHeaderNames</span>.<span title="=&gt; List[java.lang.String]">toList</span>.<span title="(f: java.lang.String =&gt; (java.lang.String, String))(implicit bf: scala.collection.generic.CanBuildFrom[List[java.lang.String],(java.lang.String, String),List[Product2[String,String]]])List[Product2[String,String]]">map</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,(java.lang.String, String),List[(java.lang.String, String)]]" class="delimiter">{</span> <a title="java.lang.String" id="41862">name</a> =&gt;
        <a href="#41862" title="(x: java.lang.String)ArrowAssoc[java.lang.String]">name</a> <span title="(y: String)(java.lang.String, String)">-&gt;</span> <a href="#41692" title="javax.servlet.http.HttpServletRequest">req</a>.<span title="(x$1: java.lang.String)java.util.Enumeration[java.lang.String]">getHeaders</span><span title="(i: java.util.Enumeration[java.lang.String])Iterator[java.lang.String]" class="delimiter">(</span><a href="#41862" title="java.lang.String">name</a><span class="delimiter">)</span>.<span title="=&gt; List[java.lang.String]">toList</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;, &quot;)" class="string">&quot;, &quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span title="(method: cc.spray.http.HttpMethod, uri: String, headers: List[cc.spray.http.HttpHeader], content: Option[cc.spray.http.HttpContent], protocol: cc.spray.http.HttpProtocol)cc.spray.http.HttpRequest">HttpRequest</span><span class="delimiter">(</span>
      method = <span title="object cc.spray.http.HttpMethods">HttpMethods</span>.<span title="(key: String)Option[cc.spray.http.HttpMethod]">getForKey</span><span class="delimiter">(</span><a href="#41692" title="javax.servlet.http.HttpServletRequest">req</a>.<span title="()java.lang.String">getMethod</span><span class="delimiter">)</span>.<span title="=&gt; cc.spray.http.HttpMethod">get</span>,
      uri = <a href="#40564" title="(req: javax.servlet.http.HttpServletRequest)java.lang.String">rebuildUri</a><span class="delimiter">(</span><a href="#41692" title="javax.servlet.http.HttpServletRequest">req</a><span class="delimiter">)</span>,
      headers = <a href="#41698" title="List[cc.spray.http.HttpHeader]">regularHeaders</a>,
      content = <a href="#40565" title="(inputStream: java.io.InputStream, contentTypeHeader: Option[cc.spray.http.HttpHeaders.Content-Type], contentLengthHeader: Option[cc.spray.http.HttpHeaders.Content-Length])Option[cc.spray.http.HttpContent]">httpContent</a><span class="delimiter">(</span><a href="#41692" title="javax.servlet.http.HttpServletRequest">req</a>.<span title="()javax.servlet.ServletInputStream">getInputStream</span>, <a href="#41696" title="Option[cc.spray.http.HttpHeaders.Content-Type]">contentTypeHeader</a>, <a href="#41697" title="Option[cc.spray.http.HttpHeaders.Content-Length]">contentLengthHeader</a><span class="delimiter">)</span>,
      protocol = <span title="object cc.spray.http.HttpProtocols">HttpProtocols</span>.<span title="(key: String)Option[cc.spray.http.HttpProtocol]">getForKey</span><span class="delimiter">(</span><a href="#41692" title="javax.servlet.http.HttpServletRequest">req</a>.<span title="()java.lang.String">getProtocol</span><span class="delimiter">)</span>.<span title="=&gt; cc.spray.http.HttpProtocol">get</span>
    <span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(req: javax.servlet.http.HttpServletRequest)java.lang.String" id="40564">rebuildUri</a><span class="delimiter">(</span><a title="javax.servlet.http.HttpServletRequest" id="42021">req</a>: <span title="javax.servlet.http.HttpServletRequest">HttpServletRequest</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="42024">uri</a> = <a href="#42021" title="javax.servlet.http.HttpServletRequest">req</a>.<span title="()java.lang.String">getRequestURI</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="42025">queryString</a> = <a href="#42021" title="javax.servlet.http.HttpServletRequest">req</a>.<span title="()java.lang.String">getQueryString</span>
    <span title="java.lang.String" class="keyword">if</span> <span class="delimiter">(</span><a href="#42025" title="java.lang.String">queryString</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#42025" title="java.lang.String">queryString</a>.<span title="()Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <a href="#42024" title="java.lang.String">uri</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="Char(\'?\')" class="char">'?'</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#42025" title="java.lang.String">queryString</a> <span class="keyword">else</span> <a href="#42024" title="java.lang.String">uri</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(inputStream: java.io.InputStream, contentTypeHeader: Option[cc.spray.http.HttpHeaders.Content-Type], contentLengthHeader: Option[cc.spray.http.HttpHeaders.Content-Length])Option[cc.spray.http.HttpContent]" id="40565">httpContent</a><span class="delimiter">(</span><a title="java.io.InputStream" id="42034">inputStream</a>: <span title="java.io.InputStream">InputStream</span>, <a title="Option[cc.spray.http.HttpHeaders.Content-Type]" id="42035">contentTypeHeader</a>: <span title="Option[cc.spray.http.HttpHeaders.Content-Type]">Option</span><span class="delimiter">[</span>`Content-Type`<span class="delimiter">]</span>,
                  <a title="Option[cc.spray.http.HttpHeaders.Content-Length]" id="42036">contentLengthHeader</a>: <span title="Option[cc.spray.http.HttpHeaders.Content-Length]">Option</span><span class="delimiter">[</span>`Content-Length`<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Option[cc.spray.http.HttpContent]">Option</span><span class="delimiter">[</span>HttpContent<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#42036" title="Option[cc.spray.http.HttpHeaders.Content-Length]">contentLengthHeader</a>.<span title="(f: cc.spray.http.HttpHeaders.Content-Length =&gt; Option[cc.spray.http.HttpContent])Option[cc.spray.http.HttpContent]">flatMap</span> <a href="#42094" title="Option[cc.spray.http.HttpContent]" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="None.type">`Content-Length`</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span> =&gt; <span title="object None">None</span>
      <span class="keyword">case</span> <span title="Some[cc.spray.http.HttpContent]">`Content-Length`</span><span class="delimiter">(</span><a title="Int" id="42095">contentLength</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="42096">body</a> = <span title="Array[Byte]" class="keyword">if</span> <span class="delimiter">(</span><a href="#42095" title="Int">contentLength</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#40556" title="=&gt; Array[Byte]">EmptyByteArray</a> <span class="keyword">else</span> <span class="keyword">try</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Array[Byte]" id="42102">buf</a> = <span title="Array[Byte]" class="keyword">new</span> <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">(</span><a href="#42095" title="Int">contentLength</a><span class="delimiter">)</span>
          <span class="keyword">var</span> <a title="Int" id="42103">bytesRead</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#42103" title="Int">bytesRead</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#42095" title="Int">contentLength</a><span class="delimiter">)</span> <a href="#42104" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="Int" id="42111">count</a> = <a href="#42034" title="java.io.InputStream">inputStream</a>.<span title="(x$1: Array[Byte], x$2: Int, x$3: Int)Int">read</span><span class="delimiter">(</span><a href="#42102" title="Array[Byte]">buf</a>, <a href="#42103" title="Int">bytesRead</a>, <a href="#42095" title="Int">contentLength</a> <span title="(x: Int)Int">-</span> <a href="#42103" title="Int">bytesRead</a><span class="delimiter">)</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42111" title="Int">count</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#42103" title="Int">bytesRead</a> <span title="(x: Int)Int">+=</span> <a href="#42111" title="Int">count</a>
            <span class="keyword">else</span> <span title="Nothing" class="keyword">throw</span> <span title="cc.spray.http.HttpException" class="keyword">new</span> <span title="cc.spray.http.HttpException">HttpException</span><span class="delimiter">(</span><span title="=&gt; cc.spray.http.StatusCodes.ClientError">BadRequest</span>, <span title="java.lang.String(&quot;Illegal Servlet request entity, expected length &quot;)" class="string">&quot;Illegal Servlet request entity, expected length &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
                    <a href="#42095" title="Int">contentLength</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; but only has length &quot;)" class="string">&quot; but only has length &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#42103" title="Int">bytesRead</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <a href="#42102" title="Array[Byte]">buf</a>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Nothing" id="42128">e</a>: <span title="java.io.IOException">IOException</span> =&gt;
            <span title="Nothing" class="keyword">throw</span> <span title="cc.spray.http.HttpException" class="keyword">new</span> <span title="cc.spray.http.HttpException">HttpException</span><span class="delimiter">(</span><span title="=&gt; cc.spray.http.StatusCodes.ServerError">InternalServerError</span>, <span title="java.lang.String(&quot;Could not read request entity due to &quot;)" class="string">&quot;Could not read request entity due to &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#42128" title="java.io.IOException">e</a>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="keyword">val</span> <a title="cc.spray.http.ContentType" id="42097">contentType</a> = <a href="#42035" title="Option[cc.spray.http.HttpHeaders.Content-Type]">contentTypeHeader</a>.<span title="(f: cc.spray.http.HttpHeaders.Content-Type =&gt; cc.spray.http.ContentType)Option[cc.spray.http.ContentType]">map</span><span class="delimiter">(</span><a href="#42142" title="cc.spray.http.HttpHeaders.Content-Type">_</a>.<span title="=&gt; cc.spray.http.ContentType">contentType</span><span class="delimiter">)</span>.<span title="(default: =&gt; cc.spray.http.ContentType)cc.spray.http.ContentType">getOrElse</span><span class="delimiter">(</span><span title="(mediaType: cc.spray.http.MediaType)cc.spray.http.ContentType">ContentType</span><span class="delimiter">(</span><span title="=&gt; cc.spray.http.MediaType">`application/octet-stream`</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="(x: cc.spray.http.HttpContent)Some[cc.spray.http.HttpContent]">Some</span><span class="delimiter">(</span><span title="(contentType: cc.spray.http.ContentType, buffer: Array[Byte])cc.spray.http.HttpContent">HttpContent</span><span class="delimiter">(</span><a href="#42097" title="cc.spray.http.ContentType">contentType</a>, <a href="#42096" title="Array[Byte]">body</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(req: javax.servlet.http.HttpServletRequest, servletResponse: javax.servlet.http.HttpServletResponse, response: cc.spray.http.HttpResponse)Unit" id="40566">respond</a><span class="delimiter">(</span><a title="javax.servlet.http.HttpServletRequest" id="42069">req</a>: <span title="javax.servlet.http.HttpServletRequest">HttpServletRequest</span>, <a title="javax.servlet.http.HttpServletResponse" id="42070">servletResponse</a>: <span title="javax.servlet.http.HttpServletResponse">HttpServletResponse</span>, <a title="cc.spray.http.HttpResponse" id="42071">response</a>: <span title="cc.spray.http.HttpResponse">HttpResponse</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      <a href="#42070" title="javax.servlet.http.HttpServletResponse">servletResponse</a>.<span title="(x$1: Int)Unit">setStatus</span><span class="delimiter">(</span><a href="#42071" title="cc.spray.http.HttpResponse">response</a>.<span title="=&gt; cc.spray.http.StatusCode">status</span>.<span title="=&gt; Int">value</span><span class="delimiter">)</span>
      <a href="#42071" title="cc.spray.http.HttpResponse">response</a>.<span title="=&gt; List[cc.spray.http.HttpHeader]">headers</span>.<span title="(f: cc.spray.http.HttpHeader =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="cc.spray.http.HttpHeader" id="42208">header</a> =&gt; <a href="#42070" title="javax.servlet.http.HttpServletResponse">servletResponse</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String)Unit">addHeader</span><span class="delimiter">(</span><a href="#42208" title="cc.spray.http.HttpHeader">header</a>.<span title="=&gt; java.lang.String">name</span>, <a href="#42208" title="cc.spray.http.HttpHeader">header</a>.<span title="=&gt; String">value</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#42071" title="cc.spray.http.HttpResponse">response</a>.<span title="=&gt; Option[cc.spray.http.HttpContent]">content</span>.<span title="(f: cc.spray.http.HttpContent =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="cc.spray.http.HttpContent" id="42214">content</a> =&gt;
        <a href="#42070" title="javax.servlet.http.HttpServletResponse">servletResponse</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String)Unit">addHeader</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Content-Type&quot;)" class="string">&quot;Content-Type&quot;</span>, <a href="#42214" title="cc.spray.http.HttpContent">content</a>.<span title="=&gt; cc.spray.http.ContentType">contentType</span>.<span title="=&gt; String">value</span><span class="delimiter">)</span>
        <a href="#42070" title="javax.servlet.http.HttpServletResponse">servletResponse</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String)Unit">addHeader</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Content-Length&quot;)" class="string">&quot;Content-Length&quot;</span>, <a href="#42214" title="cc.spray.http.HttpContent">content</a>.<span title="=&gt; Array[Byte]">buffer</span>.<span title="=&gt; Int">length</span>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span>
        <a href="#42070" title="javax.servlet.http.HttpServletResponse">servletResponse</a>.<span title="()javax.servlet.ServletOutputStream">getOutputStream</span>.<span title="(x$1: Array[Byte])Unit">write</span><span class="delimiter">(</span><a href="#42214" title="cc.spray.http.HttpContent">content</a>.<span title="=&gt; Array[Byte]">buffer</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="42263">e</a>: <span title="java.io.IOException">IOException</span> =&gt; <a href="#9690" title="=&gt; cc.spray.utils.Log">log</a>.<span title="(msgFmt: String, a: =&gt; Any, b: =&gt; Any)Unit">error</span><span class="delimiter">(</span><span class="string">&quot;Could not write response body of %s, probably the request has either timed out&quot;</span> <span title="java.lang.String(&quot;Could not write response body of %s, probably the request has either timed outor the client has disconnected (%s)&quot;)">+</span>
        <span class="string">&quot;or the client has disconnected (%s)&quot;</span>, <a href="#40569" title="(req: javax.servlet.http.HttpServletRequest)java.lang.String">requestString</a><span class="delimiter">(</span><a href="#42069" title="javax.servlet.http.HttpServletRequest">req</a><span class="delimiter">)</span>, <a href="#42263" title="java.io.IOException">e</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="Unit" id="42276">e</a>: <span title="Exception">Exception</span> =&gt; <a href="#9690" title="=&gt; cc.spray.utils.Log">log</a>.<span title="(cause: Throwable, msgFmt: String, a: =&gt; Any)Unit">error</span><span class="delimiter">(</span><a href="#42276" title="Exception">e</a>, <span title="java.lang.String(&quot;Could not complete %s&quot;)" class="string">&quot;Could not complete %s&quot;</span>, <a href="#40569" title="(req: javax.servlet.http.HttpServletRequest)java.lang.String">requestString</a><span class="delimiter">(</span><a href="#42069" title="javax.servlet.http.HttpServletRequest">req</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(req: javax.servlet.http.HttpServletRequest)(f: cc.spray.http.HttpResponse =&gt; Unit)cc.spray.RoutingResult =&gt; Unit" id="40567">responderFor</a><span class="delimiter">(</span><a title="javax.servlet.http.HttpServletRequest" id="42286">req</a>: <span title="javax.servlet.http.HttpServletRequest">HttpServletRequest</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="cc.spray.http.HttpResponse =&gt; Unit" id="42287">f</a>: HttpResponse =&gt; Unit<span class="delimiter">)</span>: RoutingResult =&gt; Unit = <a href="#42290" title="Unit" class="delimiter">{</a>
    <span class="keyword">case</span> <span title="Unit">Respond</span><span class="delimiter">(</span><a title="cc.spray.http.HttpResponse" id="42291">response</a><span class="delimiter">)</span> =&gt;
      <span class="keyword">try</span> <span class="delimiter">{</span>
        <a href="#42287" title="(v1: cc.spray.http.HttpResponse)Unit">f</a><span class="delimiter">(</span><a href="#42291" title="cc.spray.http.HttpResponse">response</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="42293">e</a>: <span title="java.lang.IllegalStateException">IllegalStateException</span> =&gt; <a href="#9690" title="=&gt; cc.spray.utils.Log">log</a>.<span title="(msgFmt: String, a: =&gt; Any, b: =&gt; Any)Unit">error</span><span class="delimiter">(</span><span class="string">&quot;Could not complete %s, it probably timed out and has therefore&quot;</span> <span title="java.lang.String(&quot;Could not complete %s, it probably timed out and has thereforealready been completed (%s)&quot;)">+</span>
          <span class="string">&quot;already been completed (%s)&quot;</span>, <a href="#40569" title="(req: javax.servlet.http.HttpServletRequest)java.lang.String">requestString</a><span class="delimiter">(</span><a href="#42286" title="javax.servlet.http.HttpServletRequest">req</a><span class="delimiter">)</span>, <a href="#42293" title="java.lang.IllegalStateException">e</a><span class="delimiter">)</span>
        <span class="keyword">case</span> <a title="Unit" id="42303">e</a>: <span title="Exception">Exception</span> =&gt; <a href="#9690" title="=&gt; cc.spray.utils.Log">log</a>.<span title="(msgFmt: String, a: =&gt; Any, b: =&gt; Any)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not complete %s due to %s&quot;)" class="string">&quot;Could not complete %s due to %s&quot;</span>, <a href="#40569" title="(req: javax.servlet.http.HttpServletRequest)java.lang.String">requestString</a><span class="delimiter">(</span><a href="#42286" title="javax.servlet.http.HttpServletRequest">req</a><span class="delimiter">)</span>, <a href="#42303" title="Exception">e</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="Nothing">_</span>: <a href="../RoutingResult.scala.html#9627" title="cc.spray.Reject">Reject</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="java.lang.IllegalStateException" class="keyword">new</span> <span title="java.lang.IllegalStateException">IllegalStateException</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(req: javax.servlet.http.HttpServletRequest, resp: javax.servlet.http.HttpServletResponse)(complete: =&gt; Unit)Unit" id="40568">handleTimeout</a><span class="delimiter">(</span><a title="javax.servlet.http.HttpServletRequest" id="42315">req</a>: <span title="javax.servlet.http.HttpServletRequest">HttpServletRequest</span>, <a title="javax.servlet.http.HttpServletResponse" id="42316">resp</a>: <span title="javax.servlet.http.HttpServletResponse">HttpServletResponse</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="=&gt; Unit" id="42317">complete</a>: =&gt; Unit<span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.util.concurrent.CountDownLatch" id="42319">latch</a> = <span title="java.util.concurrent.CountDownLatch" class="keyword">new</span> <span title="java.util.concurrent.CountDownLatch">CountDownLatch</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>;
    <span class="keyword">val</span> <a title="cc.spray.RoutingResult =&gt; Unit" id="42320">responder</a> = <a href="#40567" title="(req: javax.servlet.http.HttpServletRequest)(f: cc.spray.http.HttpResponse =&gt; Unit)cc.spray.RoutingResult =&gt; Unit">responderFor</a><span class="delimiter">(</span><a href="#42315" title="javax.servlet.http.HttpServletRequest">req</a><span class="delimiter">)</span> <span class="delimiter">{</span> <a title="cc.spray.http.HttpResponse" id="42334">response</a> =&gt;
      <a href="#40566" title="(req: javax.servlet.http.HttpServletRequest, servletResponse: javax.servlet.http.HttpServletResponse, response: cc.spray.http.HttpResponse)Unit">respond</a><span class="delimiter">(</span><a href="#42315" title="javax.servlet.http.HttpServletRequest">req</a>, <a href="#42316" title="javax.servlet.http.HttpServletResponse">resp</a>, <a href="#42334" title="cc.spray.http.HttpResponse">response</a><span class="delimiter">)</span>
      <a href="#42317" title="=&gt; Unit">complete</a>
      <a href="#42319" title="java.util.concurrent.CountDownLatch">latch</a>.<span title="()Unit">countDown</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#40562" title="(req: javax.servlet.http.HttpServletRequest, resp: javax.servlet.http.HttpServletResponse, responder: cc.spray.RoutingResult =&gt; Unit)Option[cc.spray.RequestContext]">requestContext</a><span class="delimiter">(</span><a href="#42315" title="javax.servlet.http.HttpServletRequest">req</a>, <a href="#42316" title="javax.servlet.http.HttpServletResponse">resp</a>, <a href="#42320" title="cc.spray.RoutingResult =&gt; Unit">responder</a><span class="delimiter">)</span>.<span title="(f: cc.spray.RequestContext =&gt; Boolean)Unit">foreach</span> <span class="delimiter">{</span> <a title="cc.spray.RequestContext" id="42339">context</a> =&gt;
      <a href="#9690" title="=&gt; cc.spray.utils.Log">log</a>.<span title="(msgFmt: String, a: =&gt; Any)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Timeout of %s&quot;)" class="string">&quot;Timeout of %s&quot;</span>, <a href="#42339" title="cc.spray.RequestContext">context</a>.<a href="../RequestContext.scala.html#23742" title="=&gt; cc.spray.http.HttpRequest">request</a><span class="delimiter">)</span>
      <a href="#40554" title="=&gt; akka.actor.ActorRef">timeoutActor</a> <span title="(msg: Any)(implicit sender: akka.actor.UntypedChannel)Unit">!</span> <a href="../RootService.scala.html#35075" title="(context: cc.spray.RequestContext)cc.spray.Timeout">Timeout</a><span class="delimiter">(</span><a href="#42339" title="cc.spray.RequestContext">context</a><span class="delimiter">)</span>
      <a href="#42319" title="java.util.concurrent.CountDownLatch">latch</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)Boolean">await</span><span class="delimiter">(</span><a href="#40559" title="=&gt; Long">timeout</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span> <span class="comment">// give the timeoutActor another `timeout` ms for completing</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(req: javax.servlet.http.HttpServletRequest)java.lang.String" id="40569">requestString</a><span class="delimiter">(</span><a title="javax.servlet.http.HttpServletRequest" id="42273">req</a>: <span title="javax.servlet.http.HttpServletRequest">HttpServletRequest</span><span class="delimiter">)</span> = <a href="#42273" title="javax.servlet.http.HttpServletRequest">req</a>.<span title="()java.lang.String">getMethod</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; request to \'&quot;)" class="string">&quot; request to '&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#40564" title="(req: javax.servlet.http.HttpServletRequest)java.lang.String">rebuildUri</a><span class="delimiter">(</span><a href="#42273" title="javax.servlet.http.HttpServletRequest">req</a><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;\'&quot;)" class="string">&quot;'&quot;</span>

<span class="delimiter">}</span>
        </pre>
    </body>
</html>