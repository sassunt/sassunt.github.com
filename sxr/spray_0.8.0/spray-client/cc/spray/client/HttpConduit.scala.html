<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>cc/spray/client/HttpConduit.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright (C) 2011 Mathias Doenitz
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> cc.spray
<span class="keyword">package</span> client

<span class="keyword">import</span> utils._
<span class="keyword">import</span> http._
<span class="keyword">import</span> akka.actor.Actor
<span class="keyword">import</span> akka.actor.<span title="object akka.actor.Actor">Actor</span>._
<span class="keyword">import</span> can.<span class="delimiter">{</span>HttpConnection, Connect<span class="delimiter">}</span>
<span class="keyword">import</span> akka.dispatch.<span class="delimiter">{</span>DefaultCompletableFuture, Future<span class="delimiter">}</span>
<span class="keyword">import</span> <span title="object cc.spray.http.HttpProtocols">HttpProtocols</span>._

<span class="keyword">class</span> <a title="class HttpConduit extends java.lang.Object with cc.spray.client.MessagePipelining with cc.spray.utils.Logging with cc.spray.SprayCanConversions with ScalaObject" id="9513">HttpConduit</a><a href="#9513" title="ScalaObject" class="delimiter">(</a><a title="String" id="26920">host</a>: <span title="String">String</span>, <a title="Int" id="26924">port</a>: <span title="Int">Int</span> = <span title="Int(80)" class="int">80</span>, <a title="cc.spray.client.ConduitConfig" id="26925">config</a>: <a href="ConduitConfig.scala.html#9487" title="cc.spray.client.ConduitConfig">ConduitConfig</a> = <a href="ConduitConfig.scala.html#9488" title="object cc.spray.client.ConduitConfig">ConduitConfig</a>.<a href="ConduitConfig.scala.html#10163" title="=&gt; cc.spray.client.ConduitConfig">fromAkkaConf</a><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="MessagePipelining.scala.html#9522" title="cc.spray.client.MessagePipelining">MessagePipelining</a> <span class="keyword">with</span> <span title="cc.spray.utils.Logging">Logging</span> <span class="keyword">with</span> <span title="cc.spray.SprayCanConversions">SprayCanConversions</span> <span class="delimiter">{</span>

  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="akka.actor.ActorRef" id="25749">httpClient</a> = <span title="object cc.spray.utils.ActorHelpers">ActorHelpers</span>.<span title="(id: String)akka.actor.ActorRef">actor</span><span class="delimiter">(</span><a href="#26925" title="cc.spray.client.ConduitConfig">config</a>.<a href="ConduitConfig.scala.html#9832" title="=&gt; String">clientActorId</a><span class="delimiter">)</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="akka.actor.ActorRef" id="25750">mainActor</a> = <span title="(factory: =&gt; akka.actor.Actor)akka.actor.ActorRef">actorOf</span><span class="delimiter">(</span><span title="HttpConduit.this.MainActor" class="keyword">new</span> <a href="#25758" title="HttpConduit.this.MainActor">MainActor</a><span class="delimiter">)</span>.<span title="()akka.actor.ActorRef">start</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="cc.spray.http.HttpRequest =&gt; akka.dispatch.Future[cc.spray.http.HttpResponse]" id="25752">sendReceive</a>: <span title="cc.spray.http.HttpRequest =&gt; akka.dispatch.Future[cc.spray.http.HttpResponse]">SendReceive</span> = <span class="delimiter">{</span> <a title="cc.spray.http.HttpRequest" id="26927">request</a> =&gt;
    <span title="(a: akka.dispatch.DefaultCompletableFuture[cc.spray.http.HttpResponse])(f: akka.dispatch.DefaultCompletableFuture[cc.spray.http.HttpResponse] =&gt; Unit)akka.dispatch.DefaultCompletableFuture[cc.spray.http.HttpResponse]">make</span><span class="delimiter">(</span><span title="(timeout: Long)(implicit dispatcher: akka.dispatch.MessageDispatcher)akka.dispatch.DefaultCompletableFuture[cc.spray.http.HttpResponse]" class="keyword">new</span> <span title="akka.dispatch.DefaultCompletableFuture[cc.spray.http.HttpResponse]">DefaultCompletableFuture</span><span class="delimiter">[</span>HttpResponse<span class="delimiter">]</span><span class="delimiter">(</span>Long.<span title="Long(9223372036854775807L)">MaxValue</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a title="akka.dispatch.DefaultCompletableFuture[cc.spray.http.HttpResponse]" id="27694">future</a> =&gt;
      <a href="#25750" title="=&gt; akka.actor.ActorRef">mainActor</a> <span title="(msg: Any)(implicit sender: akka.actor.UntypedChannel)Unit">!</span> <a href="#27871" title="(request: cc.spray.http.HttpRequest, responder: Either[Throwable,cc.spray.http.HttpResponse] =&gt; Unit)HttpConduit.this.Send">Send</a><span class="delimiter">(</span><a href="#26927" title="cc.spray.http.HttpRequest">request</a>, <span class="delimiter">{</span> <a title="Either[Throwable,cc.spray.http.HttpResponse]" id="27900">result</a> =&gt; <a href="#27694" title="akka.dispatch.DefaultCompletableFuture[cc.spray.http.HttpResponse]">future</a>.<span title="(value: Either[Throwable,cc.spray.http.HttpResponse])future.type">complete</span><span class="delimiter">(</span><a href="#27900" title="Either[Throwable,cc.spray.http.HttpResponse]">result</a><span class="delimiter">)</span>; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="25754">close</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#25750" title="=&gt; akka.actor.ActorRef">mainActor</a>.<span title="()Unit">stop</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> case <span class="keyword">class</span> <a title="class Send extends java.lang.Object with cc.spray.client.HttpRequestContext with ScalaObject with Product with Serializable" id="27871">Send</a><a href="#27871" title="ScalaObject" class="delimiter">(</a><a title="cc.spray.http.HttpRequest" id="27892">request</a>: <span title="cc.spray.http.HttpRequest">HttpRequest</span>, <a title="Either[Throwable,cc.spray.http.HttpResponse] =&gt; Unit" id="27893">responder</a>: Either<span class="delimiter">[</span>Throwable, HttpResponse<span class="delimiter">]</span> =&gt; Unit<span class="delimiter">)</span>
    <span class="keyword">extends</span> <a href="DispatchStrategies.scala.html#9499" title="cc.spray.client.HttpRequestContext">HttpRequestContext</a>

  <span class="keyword">protected</span> <span class="keyword">class</span> <a title="class MainActor extends java.lang.Object with akka.actor.Actor with ScalaObject" id="25758">MainActor</a> <a href="#25758" title="ScalaObject" class="keyword">extends</a> <span title="akka.actor.Actor">Actor</span> <span class="delimiter">{</span>
    case <span class="keyword">class</span> <a title="class ConnectionResult extends java.lang.Object with ScalaObject with Product with Serializable" id="28071">ConnectionResult</a><a href="#28071" title="ScalaObject" class="delimiter">(</a><a title="MainActor.this.Conn" id="29994">conn</a>: <a href="#26331" title="MainActor.this.Conn">Conn</a>, <a title="HttpConduit.this.Send" id="29995">send</a>: <a href="#27871" title="HttpConduit.this.Send">Send</a>, <a title="Either[Throwable,cc.spray.can.HttpConnection]" id="29996">result</a>: <span title="Either[Throwable,cc.spray.can.HttpConnection]">Either</span><span class="delimiter">[</span>Throwable, HttpConnection<span class="delimiter">]</span><span class="delimiter">)</span>
    case <span class="keyword">class</span> <a title="class Respond extends java.lang.Object with ScalaObject with Product with Serializable" id="28175">Respond</a><a href="#28175" title="ScalaObject" class="delimiter">(</a><a title="MainActor.this.Conn" id="30091">conn</a>: <a href="#26331" title="MainActor.this.Conn">Conn</a>, <a title="HttpConduit.this.Send" id="30092">send</a>: <a href="#27871" title="HttpConduit.this.Send">Send</a>, <a title="Either[Throwable,cc.spray.http.HttpResponse]" id="30093">result</a>: <span title="Either[Throwable,cc.spray.http.HttpResponse]">Either</span><span class="delimiter">[</span>Throwable, HttpResponse<span class="delimiter">]</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Seq[MainActor.this.Conn]" id="26326">conns</a> = <span title="object Seq">Seq</span>.<span title="(n: Int)(elem: =&gt; MainActor.this.Conn)Seq[MainActor.this.Conn]">fill</span><span class="delimiter">(</span><a href="#26925" title="cc.spray.client.ConduitConfig">config</a>.<a href="ConduitConfig.scala.html#9834" title="=&gt; Int">maxConnections</a><span class="delimiter">)</span><span class="delimiter">(</span><span title="MainActor.this.Conn" class="keyword">new</span> <a href="#26331" title="MainActor.this.Conn">Conn</a><span class="delimiter">)</span>

    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; PartialFunction[Any,Unit]" id="26328">receive</a> = <a href="#28230" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <a title="Unit" id="28231">send</a>: <a href="#27871" title="HttpConduit.this.Send">Send</a> =&gt; <a href="#26925" title="cc.spray.client.ConduitConfig">config</a>.<a href="ConduitConfig.scala.html#9836" title="=&gt; cc.spray.client.DispatchStrategy">dispatchStrategy</a>.<a href="DispatchStrategies.scala.html#10157" title="(context: cc.spray.client.HttpRequestContext, conns: Seq[cc.spray.client.HttpConn])Unit">dispatch</a><span class="delimiter">(</span><a href="#28231" title="HttpConduit.this.Send">send</a>, <a href="#26326" title="=&gt; Seq[MainActor.this.Conn]">conns</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">Respond</span><span class="delimiter">(</span><a title="MainActor.this.Conn" id="28232">conn</a>, Send<span class="delimiter">(</span><a title="cc.spray.http.HttpRequest" id="28233">request</a>, <a title="Either[Throwable,cc.spray.http.HttpResponse] =&gt; Unit" id="28234">responder</a><span class="delimiter">)</span>, <a title="Either[Throwable,cc.spray.http.HttpResponse]" id="28235">result</a><span class="delimiter">)</span> =&gt;
        <a href="#9513" title="=&gt; cc.spray.utils.Log">log</a>.<span title="(msgFmt: String, a: =&gt; Any, b: =&gt; Any, c: =&gt; Any)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Dispatching \'%s\' response to %s&quot;)" class="string">&quot;Dispatching '%s' response to %s&quot;</span>, <a href="#28235" title="Either[Throwable,cc.spray.http.HttpResponse]">result</a>.<span title="(fa: Throwable =&gt; Any, fb: cc.spray.http.HttpResponse =&gt; Any)Any">fold</span><span class="delimiter">(</span><a href="#28568" title="Throwable">_</a>.<span title="()java.lang.String">toString</span>, <a href="#28570" title="cc.spray.http.HttpResponse">_</a>.<span title="=&gt; cc.spray.http.StatusCode">status</span>.<span title="=&gt; Int">value</span><span class="delimiter">)</span>, <a href="#26330" title="(request: cc.spray.http.HttpRequest)String">requestString</a><span class="delimiter">(</span><a href="#28233" title="cc.spray.http.HttpRequest">request</a><span class="delimiter">)</span>, <a href="#28235" title="Either[Throwable,cc.spray.http.HttpResponse]">result</a><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#28235" title="Either[Throwable,cc.spray.http.HttpResponse]">result</a>.<span title="=&gt; Boolean">isLeft</span> <span title="(x: Boolean)Boolean">||</span> <a href="#26329" title="(response: cc.spray.http.HttpResponse)Boolean">closeExpected</a><span class="delimiter">(</span><a href="#28235" title="Either[Throwable,cc.spray.http.HttpResponse]">result</a>.<span title="=&gt; Either.RightProjection[Throwable,cc.spray.http.HttpResponse]">right</span>.<span title="=&gt; cc.spray.http.HttpResponse">get</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#28232" title="MainActor.this.Conn">conn</a>.<a href="#28008" title="(x$1: Int)Unit">pendingResponses</a> = -<span title="Int(-1)" class="int">1</span>
          <a href="#28232" title="MainActor.this.Conn">conn</a>.<a href="#28011" title="(x$1: Option[Either[akka.dispatch.Future[cc.spray.can.HttpConnection],cc.spray.can.HttpConnection]])Unit">httpConnection</a> = <span title="object None">None</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <a href="#28232" title="MainActor.this.Conn">conn</a>.<a href="#28008" title="(x$1: Int)Unit">pendingResponses</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
        <a href="#28234" title="(v1: Either[Throwable,cc.spray.http.HttpResponse])Unit">responder</a><span class="delimiter">(</span><a href="#28235" title="Either[Throwable,cc.spray.http.HttpResponse]">result</a><span class="delimiter">)</span>
        <a href="#26925" title="cc.spray.client.ConduitConfig">config</a>.<a href="ConduitConfig.scala.html#9836" title="=&gt; cc.spray.client.DispatchStrategy">dispatchStrategy</a>.<a href="DispatchStrategies.scala.html#10158" title="(conns: Seq[cc.spray.client.HttpConn])Unit">onStateChange</a><span class="delimiter">(</span><a href="#26326" title="=&gt; Seq[MainActor.this.Conn]">conns</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">ConnectionResult</span><span class="delimiter">(</span><a title="MainActor.this.Conn" id="29483">conn</a>, <a title="HttpConduit.this.Send" id="29484">send</a>, Right<span class="delimiter">(</span><a title="cc.spray.can.HttpConnection" id="29522">httpConnection</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
        <a href="#29483" title="MainActor.this.Conn">conn</a>.<a href="#28011" title="(x$1: Option[Either[akka.dispatch.Future[cc.spray.can.HttpConnection],cc.spray.can.HttpConnection]])Unit">httpConnection</a> = <span title="(x: Right[Nothing,cc.spray.can.HttpConnection])Some[Right[Nothing,cc.spray.can.HttpConnection]]">Some</span><span class="delimiter">(</span><span title="(b: cc.spray.can.HttpConnection)Right[Nothing,cc.spray.can.HttpConnection]">Right</span><span class="delimiter">(</span><a href="#29522" title="cc.spray.can.HttpConnection">httpConnection</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#29483" title="MainActor.this.Conn">conn</a>.<a href="#28008" title="(x$1: Int)Unit">pendingResponses</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span> <span class="comment">// correct for +1 in dispatch</span>
        <a href="#29483" title="MainActor.this.Conn">conn</a>.<a href="#28013" title="(requestCtx: cc.spray.client.HttpRequestContext)Unit">dispatch</a><span class="delimiter">(</span><a href="#29484" title="HttpConduit.this.Send">send</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">ConnectionResult</span><span class="delimiter">(</span><a title="MainActor.this.Conn" id="29536">conn</a>, <a title="HttpConduit.this.Send" id="29537">send</a>, Left<span class="delimiter">(</span><a title="Throwable" id="29575">error</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
        <a href="#29536" title="MainActor.this.Conn">conn</a>.<a href="#28011" title="(x$1: Option[Either[akka.dispatch.Future[cc.spray.can.HttpConnection],cc.spray.can.HttpConnection]])Unit">httpConnection</a> = <span title="object None">None</span>
        <a href="#29536" title="MainActor.this.Conn">conn</a>.<a href="#28008" title="(x$1: Int)Unit">pendingResponses</a> = -<span title="Int(-1)" class="int">1</span>
        <a href="#29537" title="HttpConduit.this.Send">send</a>.<a href="#27893" title="(v1: Either[Throwable,cc.spray.http.HttpResponse])Unit">responder</a><span class="delimiter">(</span><span title="(a: cc.spray.client.PipelineException)Left[cc.spray.client.PipelineException,Nothing]">Left</span><span class="delimiter">(</span><span title="cc.spray.client.PipelineException" class="keyword">new</span> <a href="PipelineException.scala.html#9528" title="cc.spray.client.PipelineException">PipelineException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Could not connect to %s:%s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#26920" title="String">host</a>, <a href="#26924" title="Int">port</a><span class="delimiter">)</span>, <a href="#29575" title="Throwable">error</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(response: cc.spray.http.HttpResponse)Boolean" id="26329">closeExpected</a><span class="delimiter">(</span><a title="cc.spray.http.HttpResponse" id="28612">response</a>: <span title="cc.spray.http.HttpResponse">HttpResponse</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">import</span> <a href="#28612" title="cc.spray.http.HttpResponse">response</a>._
      <span class="keyword">import</span> <span title="object cc.spray.http.HttpHeaders">HttpHeaders</span>._
      <a href="#28612" title="=&gt; cc.spray.http.HttpProtocol">protocol</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Boolean">`HTTP/1.0`</span> =&gt; <span title="=&gt; Boolean">!</span><a href="#28612" title="=&gt; List[cc.spray.http.HttpHeader]">headers</a>.<span title="(p: cc.spray.http.HttpHeader =&gt; Boolean)Boolean">exists</span><span class="delimiter">(</span><a href="#29255" title="Boolean" class="delimiter">{</a> <span class="keyword">case</span> <span title="Boolean(true)">Connection</span><span class="delimiter">(</span><a href="#29269" title="(x: Seq[String])Some[Seq[String]]">Seq</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Keep-Alive&quot;)" class="string">&quot;Keep-Alive&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="Boolean(true)" class="keyword">true</span> ; <span class="keyword">case</span> <span title="Boolean(false)">_</span> =&gt; <span title="Boolean(false)" class="keyword">false</span> <span class="delimiter">}</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Boolean">`HTTP/1.1`</span> =&gt; <a href="#28612" title="=&gt; List[cc.spray.http.HttpHeader]">headers</a>.<span title="(p: cc.spray.http.HttpHeader =&gt; Boolean)Boolean">exists</span><span class="delimiter">(</span><a href="#29305" title="Boolean" class="delimiter">{</a> <span class="keyword">case</span> <span title="Boolean(true)">Connection</span><span class="delimiter">(</span><a href="#29307" title="(x: Seq[String])Some[Seq[String]]">Seq</a><span class="delimiter">(</span><span title="java.lang.String(&quot;close&quot;)" class="string">&quot;close&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="Boolean(true)" class="keyword">true</span> ; <span class="keyword">case</span> <span title="Boolean(false)">_</span> =&gt; <span title="Boolean(false)" class="keyword">false</span> <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(request: cc.spray.http.HttpRequest)String" id="26330">requestString</a><span class="delimiter">(</span><a title="cc.spray.http.HttpRequest" id="28592">request</a>: <span title="cc.spray.http.HttpRequest">HttpRequest</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s request to http://%s:%s%s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#28592" title="cc.spray.http.HttpRequest">request</a>.<span title="=&gt; cc.spray.http.HttpMethod">method</span>, <a href="#26920" title="String">host</a>, <a href="#26924" title="Int">port</a>, <a href="#28592" title="cc.spray.http.HttpRequest">request</a>.<span title="=&gt; String">uri</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">class</span> <a title="class Conn extends java.lang.Object with cc.spray.client.HttpConn with ScalaObject" id="26331">Conn</a> <a href="#26331" title="ScalaObject" class="keyword">extends</a> <a href="DispatchStrategies.scala.html#9498" title="cc.spray.client.HttpConn">HttpConn</a> <span class="delimiter">{</span>
      <span class="keyword">implicit</span> <span class="keyword">val</span> <a title="akka.actor.Actor.Timeout" id="28005">timeout</a> = <span title="object akka.actor.Actor">Actor</span>.<span title="(timeout: Long)akka.actor.Actor.Timeout">Timeout</span><span class="delimiter">(</span>Long.<span title="Long(9223372036854775807L)">MaxValue</span><span class="delimiter">)</span> <span class="comment">// in scope for '? Connect(...)' call below</span>
      <span class="keyword">var</span> <a title="Int" id="28008">pendingResponses</a>: <span title="Int">Int</span> = -<span title="Int(-1)" class="int">1</span>
      <span class="keyword">var</span> <a title="Option[Either[akka.dispatch.Future[cc.spray.can.HttpConnection],cc.spray.can.HttpConnection]]" id="28011">httpConnection</a>: <span title="Option[Either[akka.dispatch.Future[cc.spray.can.HttpConnection],cc.spray.can.HttpConnection]]">Option</span><span class="delimiter">[</span>Either<span class="delimiter">[</span>Future<span class="delimiter">[</span>HttpConnection<span class="delimiter">]</span>, HttpConnection<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>

      <span class="keyword">def</span> <a title="(requestCtx: cc.spray.client.HttpRequestContext)Unit" id="28013">dispatch</a><span class="delimiter">(</span><a title="cc.spray.client.HttpRequestContext" id="29534">requestCtx</a>: <a href="DispatchStrategies.scala.html#9499" title="cc.spray.client.HttpRequestContext">HttpRequestContext</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="HttpConduit.this.Send" id="29887">send</a> = <a href="#29534" title="cc.spray.client.HttpRequestContext">requestCtx</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="HttpConduit.this.Send" class="delimiter">[</span><a href="#27871" title="HttpConduit.this.Send">Send</a><span class="delimiter">]</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#28011" title="=&gt; Option[Either[akka.dispatch.Future[cc.spray.can.HttpConnection],cc.spray.can.HttpConnection]]">httpConnection</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#9513" title="=&gt; cc.spray.utils.Log">log</a>.<span title="(msgFmt: String, a: =&gt; Any, b: =&gt; Any)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Opening new connection to %s:%s&quot;)" class="string">&quot;Opening new connection to %s:%s&quot;</span>, <a href="#26920" title="String">host</a>, <a href="#26924" title="Int">port</a><span class="delimiter">)</span>
          <a href="#28008" title="(x$1: Int)Unit">pendingResponses</a> = <span title="Int(1)" class="int">1</span>
          <span class="keyword">val</span> <a title="akka.dispatch.Future[cc.spray.can.HttpConnection]" id="29888">connectionFuture</a> = <span class="delimiter">(</span><a href="#25748" title="implicit akka.actor.package.actorRef2Scala : (ref: akka.actor.ActorRef)akka.actor.ScalaActorRef">httpClient</a> <a href="#25758" title="(message: Any)(implicit channel: akka.actor.UntypedChannel, implicit timeout: akka.actor.Actor.Timeout)akka.dispatch.ActorCompletableFuture">?</a> <span title="(host: String, port: Int)cc.spray.can.Connect">Connect</span><span class="delimiter">(</span><a href="#26920" title="String">host</a>, <a href="#26924" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="[A](implicit m: Manifest[A])akka.dispatch.Future[A]">mapTo</span><span title="(implicit m: Manifest[cc.spray.can.HttpConnection])akka.dispatch.Future[cc.spray.can.HttpConnection]" class="delimiter">[</span><span title="cc.spray.can.HttpConnection">HttpConnection</span><span class="delimiter">]</span>.<span title="(func: akka.dispatch.Future[cc.spray.can.HttpConnection] =&gt; Unit)akka.dispatch.Future[cc.spray.can.HttpConnection]">onComplete</span> <span class="delimiter">{</span> <a title="akka.dispatch.Future[cc.spray.can.HttpConnection]" id="29992">future</a> =&gt;
            <a href="#25758" title="=&gt; akka.actor.ScalaActorRef">self</a> <a href="#25758" title="(message: Any)(implicit channel: akka.actor.UntypedChannel)Unit">!</a> <a href="#28071" title="(conn: MainActor.this.Conn, send: HttpConduit.this.Send, result: Either[Throwable,cc.spray.can.HttpConnection])MainActor.this.ConnectionResult">ConnectionResult</a><span class="delimiter">(</span><a href="#26331" title="MainActor.this.Conn" class="keyword">this</a>, <a href="#29887" title="HttpConduit.this.Send">send</a>, <a href="#29992" title="akka.dispatch.Future[cc.spray.can.HttpConnection]">future</a>.<span title="=&gt; Option[Either[Throwable,cc.spray.can.HttpConnection]]">value</span>.<span title="=&gt; Either[Throwable,cc.spray.can.HttpConnection]">get</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <a href="#28011" title="(x$1: Option[Either[akka.dispatch.Future[cc.spray.can.HttpConnection],cc.spray.can.HttpConnection]])Unit">httpConnection</a> = <span title="(x: Left[akka.dispatch.Future[cc.spray.can.HttpConnection],Nothing])Some[Left[akka.dispatch.Future[cc.spray.can.HttpConnection],Nothing]]">Some</span><span class="delimiter">(</span><span title="(a: akka.dispatch.Future[cc.spray.can.HttpConnection])Left[akka.dispatch.Future[cc.spray.can.HttpConnection],Nothing]">Left</span><span class="delimiter">(</span><a href="#29888" title="akka.dispatch.Future[cc.spray.can.HttpConnection]">connectionFuture</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <a href="#28008" title="(x$1: Int)Unit">pendingResponses</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="keyword">def</span> <a title="(connection: cc.spray.can.HttpConnection)Unit" id="30011">dispatchTo</a><span class="delimiter">(</span><a title="cc.spray.can.HttpConnection" id="30018">connection</a>: <span title="cc.spray.can.HttpConnection">HttpConnection</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#9513" title="=&gt; cc.spray.utils.Log">log</a>.<span title="(msgFmt: String, a: =&gt; Any)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Dispatching %s&quot;)" class="string">&quot;Dispatching %s&quot;</span>, <a href="#26330" title="(request: cc.spray.http.HttpRequest)String">requestString</a><span class="delimiter">(</span><a href="#29887" title="HttpConduit.this.Send">send</a>.<a href="#27892" title="=&gt; cc.spray.http.HttpRequest">request</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#30018" title="cc.spray.can.HttpConnection">connection</a>.<span title="(request: cc.spray.can.HttpRequest)akka.dispatch.Future[cc.spray.can.HttpResponse]">send</span><span class="delimiter">(</span><a href="#9513" title="(request: cc.spray.http.HttpRequest)cc.spray.can.HttpRequest">toSprayCanRequest</a><span class="delimiter">(</span><a href="#29887" title="HttpConduit.this.Send">send</a>.<a href="#27892" title="=&gt; cc.spray.http.HttpRequest">request</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(func: akka.dispatch.Future[cc.spray.can.HttpResponse] =&gt; Unit)akka.dispatch.Future[cc.spray.can.HttpResponse]">onComplete</span> <span title="Unit" class="delimiter">{</span> <a title="akka.dispatch.Future[cc.spray.can.HttpResponse]" id="30090">future</a> =&gt;
              <a href="#25758" title="=&gt; akka.actor.ScalaActorRef">self</a> <a href="#25758" title="(message: Any)(implicit channel: akka.actor.UntypedChannel)Unit">!</a> <a href="#28175" title="(conn: MainActor.this.Conn, send: HttpConduit.this.Send, result: Either[Throwable,cc.spray.http.HttpResponse])MainActor.this.Respond">Respond</a><span class="delimiter">(</span><a href="#26331" title="MainActor.this.Conn" class="keyword">this</a>, <a href="#29887" title="HttpConduit.this.Send">send</a>, <a href="#30090" title="akka.dispatch.Future[cc.spray.can.HttpResponse]">future</a>.<span title="=&gt; Option[Either[Throwable,cc.spray.can.HttpResponse]]">value</span>.<span title="=&gt; Either[Throwable,cc.spray.can.HttpResponse]">get</span>.<span title="=&gt; Either.RightProjection[Throwable,cc.spray.can.HttpResponse]">right</span>.<span title="(f: cc.spray.can.HttpResponse =&gt; cc.spray.http.HttpResponse)Product with Either[Throwable,cc.spray.http.HttpResponse] with Serializable">map</span><span class="delimiter">(</span><a href="#9513" title="(response: cc.spray.can.HttpResponse)cc.spray.http.HttpResponse">fromSprayCanResponse</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#28011" title="=&gt; Option[Either[akka.dispatch.Future[cc.spray.can.HttpConnection],cc.spray.can.HttpConnection]]">httpConnection</a>.<span title="=&gt; Either[akka.dispatch.Future[cc.spray.can.HttpConnection],cc.spray.can.HttpConnection]">get</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="Unit">Right</span><span class="delimiter">(</span><a title="cc.spray.can.HttpConnection" id="30114">connection</a><span class="delimiter">)</span> =&gt; <a href="#30011" title="(connection: cc.spray.can.HttpConnection)Unit">dispatchTo</a><span class="delimiter">(</span><a href="#30114" title="cc.spray.can.HttpConnection">connection</a><span class="delimiter">)</span>
            <span class="keyword">case</span> <span title="Unit">Left</span><span class="delimiter">(</span><a title="akka.dispatch.Future[cc.spray.can.HttpConnection]" id="30116">future</a><span class="delimiter">)</span> =&gt; <a href="#30116" title="akka.dispatch.Future[cc.spray.can.HttpConnection]">future</a>.<span title="(pf: PartialFunction[cc.spray.can.HttpConnection,Unit])future.type">onResult</span> <a href="#30122" title="Unit" class="delimiter">{</a> <span class="keyword">case</span> <a title="Unit" id="30123">connection</a> =&gt; <a href="#30011" title="(connection: cc.spray.can.HttpConnection)Unit">dispatchTo</a><span class="delimiter">(</span><a href="#30123" title="cc.spray.can.HttpConnection">connection</a><span class="delimiter">)</span> <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>
        </pre>
    </body>
</html>